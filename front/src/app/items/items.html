<div class="container-fluid fade-in">
  
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h4 class="mb-0 fw-bold text-secondary">Gestión de Inventario</h4>
      <small class="text-muted">Visualiza y administra los bienes municipales</small>
    </div>

    <button class="btn btn-dark d-flex align-items-center gap-2 shadow-sm px-3" 
            style="border: none;"
            (click)="openTipoModal()">
      <i class="bi bi-plus-lg"></i>
      <span class="d-none d-sm-inline">Nuevo Item</span>
    </button>
  </div>
  
<!-- ============================= -->
<!-- MODAL PREVIO: Elegir tipo -->
<!-- ============================= -->
<div class="modal fade"
     [class.show]="showTipoModal"
     [style.display]="showTipoModal ? 'block' : 'none'"
     tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      
      <div class="modal-header border-bottom-0">
        <h6 class="modal-title fw-bold">
          ¿Qué tipo de item deseas agregar?
        </h6>
        <button type="button"
                class="btn-close"
                (click)="closeTipoModal()">
        </button>
      </div>

      <div class="modal-body text-center">
        
        <button class="btn btn-outline-dark w-100 mb-2"
                (click)="seleccionarTipo('TECNO')">
          <i class="bi bi-laptop me-2"></i>
          Electrónico / Tecnología
        </button>

        <button class="btn btn-outline-dark w-100"
                (click)="seleccionarTipo('MUEBLE')">
          <i class="bi bi-building me-2"></i>
          Inmueble / Mobiliario
        </button>

      </div>

    </div>
  </div>
</div>

<div class="modal-backdrop fade show" *ngIf="showTipoModal"></div>


  


  <div *ngIf="successMsg" class="alert alert-success shadow-sm py-2 mb-3 border-0 d-flex align-items-center">
    <i class="bi bi-check-circle-fill me-2"></i> {{ successMsg }}
  </div>
  <div *ngIf="errorItems" class="alert alert-danger shadow-sm py-2 mb-3 border-0 d-flex align-items-center">
    <i class="bi bi-exclamation-triangle-fill me-2"></i> {{ errorItems }}
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="p-3 border-bottom bg-light">
      <div class="row g-2 align-items-center">
        
        <div class="col-md-6">
          <input
            type="text"
            class="form-control"
            placeholder="Buscar por código, nombre, modelo o marca..."
            [(ngModel)]="searchText"
            name="searchText"
          />
        </div>

        <div class="col-md-3">
          <select
            class="form-select"
            [(ngModel)]="filtros.activo"
            name="filtroActivo"
          >
            <option [ngValue]="null">Todos</option>
            <option [ngValue]="true">Operativos</option>
            <option [ngValue]="false">Baja</option>
          </select>
        </div>

      </div>
    </div>

      
      <div *ngIf="loadingItems" class="text-center py-5 text-muted">
        <div class="spinner-border text-success mb-2" role="status"></div>
        <div>Cargando inventario...</div>
      </div>

      <div class="table-responsive" *ngIf="!loadingItems">
        <table class="table table-hover align-middle mb-0">
          <thead class="bg-light">
            <tr>
              <th class="ps-4 py-3 text-secondary text-uppercase small border-0">Código</th>
              <th class="py-3 text-secondary text-uppercase small border-0">Bien</th>
              <th class="py-3 text-secondary text-uppercase small border-0">Categoría</th>
              <th class="py-3 text-secondary text-uppercase small border-0">Modo de adquisición</th>
              <th class="py-3 text-secondary text-uppercase small border-0">Estado</th>
              <th class="text-end pe-4 py-3 text-secondary text-uppercase small border-0">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of itemsFiltrados;">
              <td class="ps-4 fw-bold text-primary">{{ item.codigo_interno }}</td>
              <td>
                <div class="fw-bold text-dark">{{ item.nombre }}</div>
                <div class="small text-muted">{{ item.modelo || 'S/M' }}</div>
              </td>
              <td>
                <span class="badge bg-light text-dark border">{{ item.categoria }}</span>
                <div class="small text-muted mt-1 ms-1">{{ item.subcategoria }}</div>
              </td>
              <td>
                <span class="badge bg-light text-dark border">{{ item.adquisicion }}</span>
              </td>
              <td>
                <span class="badge border" [ngClass]="item.activo ? 'bg-success-subtle text-success border-success-subtle' : 'bg-danger-subtle text-danger border-danger-subtle'">
                  {{ item.activo ? 'Operativo' : 'Baja' }}
                </span>
              </td>
              <td class="text-end pe-4">
                <button class="btn btn-sm btn-light text-secondary border hover-shadow" title="Ver Detalle" (click)="openDetailModal(item)">
                  <i class="bi bi-eye"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="items.length === 0">
              <td colspan="6" class="text-center py-5 text-muted">No hay items registrados</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="modal fade" [class.show]="showCreateModal" [style.display]="showCreateModal ? 'block' : 'none'" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
      <div class="modal-content border-0 shadow-lg">
        
        <div class="modal-header border-bottom-0 pb-0">
          <h5 class="modal-title fw-bold text-secondary">Nuevo Item</h5>
          <button type="button" class="btn-close" (click)="closeCreateModal()"></button>
        </div>

        <div class="modal-body pt-4">
          
          <div *ngIf="loadingCatalogs" class="text-center py-4 text-muted">
            <div class="spinner-border spinner-border-sm text-success mb-2"></div>
            <div>Cargando opciones...</div>
          </div>

          <form (ngSubmit)="create()" *ngIf="!loadingCatalogs">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">Código Interno <span class="text-danger">*</span></label>
                <input class="form-control" [(ngModel)]="form.codigo_interno" name="codigo_interno" placeholder="Ej: TIC-001" required />
              </div>
              <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">Nombre <span class="text-danger">*</span></label>
                <input class="form-control" [(ngModel)]="form.nombre" name="nombre" placeholder="Ej: Notebook HP..." required />
              </div>

              <div class="col-md-6">
                <label class="form-label small fw-bold text-muted">Modelo</label>
                <input class="form-control" [(ngModel)]="form.modelo" name="modelo" />
              </div>
             <div class="col-md-6">
                  <label class="form-label small fw-bold text-muted">Marca</label>

                  <div class="d-flex gap-2">
                    <select class="form-select" [(ngModel)]="form.id_marca" name="id_marca">
                      <option [ngValue]="null">-- Seleccionar --</option>
                      <option *ngFor="let m of catalogos.marcas" [ngValue]="m.id_marca">
                        {{ m.nombre }}
                      </option>
                    </select>

                    <!-- Botón solo cuando el tipo seleccionado es MUEBLE -->
                    <button
                      *ngIf="tiposSeleccionado === 'MUEBLE'"
                      type="button"
                      class="btn btn-outline-secondary"
                      (click)="openAddMarca()">
                      + Agregar
                    </button>
                  </div>

                  <!-- Mini input inline (sin cambiar el estilo del modal) -->
                  <div *ngIf="showAddMarca && tiposSeleccionado === 'MUEBLE'" class="mt-2">
                    <div class="input-group">
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Nombre de marca (mueble)"
                        [(ngModel)]="newMarcaNombre"
                        name="newMarcaNombre"
                      />

                      <button
                        type="button"
                        class="btn btn-success"
                        (click)="guardarMarca()"
                        [disabled]="savingMarca || !newMarcaNombre.trim()">
                        <span *ngIf="savingMarca" class="spinner-border spinner-border-sm me-2"></span>
                        Guardar
                      </button>

                      <button
                        type="button"
                        class="btn btn-light"
                        (click)="cancelAddMarca()">
                        Cancelar
                      </button>
                    </div>
                  </div>
                </div>


              <div class="col-md-12">
                <label class="form-label small fw-bold text-muted">Subcategoría <span class="text-danger">*</span></label>
                <select class="form-select" [(ngModel)]="form.id_subcategoria" name="id_subcategoria" required>
                  <option [ngValue]="null">-- Seleccionar Tipo --</option>
                  <option *ngFor="let sc of subcategoriasFiltradas" [ngValue]="sc.id_subcategoria">
                    {{ sc.categoria }} - {{ sc.nombre }}
                  </option>
                </select>
              </div>

              <div class="col-md-12">
                <label class="form-label small fw-bold text-muted">Descripción</label>
                <textarea class="form-control" rows="2" [(ngModel)]="form.descripcion" name="descripcion"></textarea>
              </div>

              <!-- ============================= -->
              <!-- FICHA TÉCNICA (según tipo) -->
              <!-- ============================= -->

              <div class="col-12">
                <hr class="my-2" />
                <div class="fw-bold text-secondary">Ficha técnica</div>
                <small class="text-muted">
                  {{ tiposSeleccionado === 'TECNO' ? 'Tecnología' : (tiposSeleccionado === 'MUEBLE' ? 'Mobiliario' : '') }}
                </small>
              </div>

                    <!-- TECNO -->
                    <div class="row g-3" *ngIf="tiposSeleccionado === 'TECNO'">
                      <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Serial</label>
                        <input class="form-control" [(ngModel)]="fichaTecno.serial" name="ft_serial" />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-bold text-muted">Procesador</label>
                        <input class="form-control" [(ngModel)]="fichaTecno.procesador" name="ft_procesador" />
                      </div>

                    <div class="col-md-4">
                      <label class="form-label small fw-bold text-muted">Memoria RAM</label>
                      <input class="form-control" [(ngModel)]="fichaTecno.memoria_ram" name="ft_ram" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small fw-bold text-muted">Disco duro</label>
                      <input class="form-control" [(ngModel)]="fichaTecno.disco_duro" name="ft_disco" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label small fw-bold text-muted">Dirección IP</label>
                      <input class="form-control" [(ngModel)]="fichaTecno.direccion_ip" name="ft_ip" />
                    </div>

                <div class="col-md-6">
                  <label class="form-label small fw-bold text-muted">Sistema Operativo</label>
                  <input class="form-control" [(ngModel)]="fichaTecno.sistema_operativo" name="ft_so" />
                </div>
                <div class="col-md-6">
                  <label class="form-label small fw-bold text-muted">Host name</label>
                  <input class="form-control" [(ngModel)]="fichaTecno.host_name" name="ft_host" />
                </div>
              </div>

                <!-- MUEBLE -->
                <div class="row g-3" *ngIf="tiposSeleccionado === 'MUEBLE'">
                  <div class="col-md-4">
                    <label class="form-label small fw-bold text-muted">Material</label>
                    <input class="form-control" [(ngModel)]="fichaMueble.material" name="fm_material" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label small fw-bold text-muted">Color</label>
                    <input class="form-control" [(ngModel)]="fichaMueble.color" name="fm_color" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label small fw-bold text-muted">Dimensiones</label>
                    <input class="form-control" [(ngModel)]="fichaMueble.dimensiones" name="fm_dimensiones" />
                  </div>
                </div>



              <div class="col-md-4">
                <label class="form-label small fw-bold text-muted">Condición</label>
                <select class="form-select" [(ngModel)]="form.condicion_fisica" name="condicion_fisica">
                  <option value="Nuevo">Nuevo</option>
                  <option value="Bueno">Bueno</option>
                  <option value="Regular">Regular</option>
                  <option value="Malo">Malo</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label fw-bold text-muted">Modo adquisición</label>
                <select class="form-select" [(ngModel)]="form.id_adquisicion" name="id_adquisicion">
                  <option *ngFor="let a of catalogos.adquisiciones" [ngValue]="a.id_adquisicion">
                    {{ a.nombre }}
                  </option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label small fw-bold text-muted">Vida Útil (Meses)</label>
                <input type="number" class="form-control" [(ngModel)]="form.vida_util_meses" name="vida_util_meses" />
              </div>
            </div>

            <button type="submit" hidden></button>
          </form>
        </div>

        <div class="modal-footer border-top-0">
          <button type="button" class="btn btn-light text-secondary" (click)="closeCreateModal()">Cancelar</button>
          <button type="button" class="btn btn-success text-white px-4" 
                  (click)="create()" 
                  [disabled]="creating"
                  style="background-color: var(--muni-primary);">
            <span *ngIf="creating" class="spinner-border spinner-border-sm me-2"></span>
            {{ creating ? 'Guardando...' : 'Guardar Item' }}
          </button>
        </div>

      </div>
    </div>
  </div>


  <!-- ============================= -->
<!-- MODAL DETALLE ITEM -->
<!-- ============================= -->
<div class="modal fade"
     [class.show]="showDetailModal"
     [style.display]="showDetailModal ? 'block' : 'none'"
     tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">

      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold text-secondary">
          Detalle del Item
        </h5>
        <button type="button" class="btn-close" (click)="closeDetailModal()"></button>
      </div>

      <div class="modal-body pt-4">

        <div *ngIf="loadingDetail" class="text-center py-4 text-muted">
          <div class="spinner-border spinner-border-sm text-success mb-2"></div>
          <div>Cargando detalle...</div>
        </div>

        <div *ngIf="errorDetail" class="alert alert-danger border-0">
          {{ errorDetail }}
        </div>

        <div *ngIf="!loadingDetail && selectItem">

          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted fw-bold">Código Interno</div>
              <div class="fw-semibold">{{ selectItem.codigo_interno }}</div>
            </div>

            <div class="col-md-6">
              <div class="small text-muted fw-bold">Nombre</div>
              <div class="fw-semibold">{{ selectItem.nombre }}</div>
            </div>

            <div class="col-md-6">
              <div class="small text-muted fw-bold">Modelo</div>
              <div>{{ selectItem.modelo || 'S/M' }}</div>
            </div>

            <div class="col-md-6">
              <div class="small text-muted fw-bold">Marca</div>
              <div>{{ selectItem.marca || 'Sin marca' }}</div>
            </div>

            <div class="col-md-6">
              <div class="small text-muted fw-bold">Categoría</div>
              <div>{{ selectItem.categoria }}</div>
            </div>

            <div class="col-md-6">
              <div class="small text-muted fw-bold">Subcategoría</div>
              <div>{{ selectItem.subcategoria }}</div>
            </div>

            <div class="col-md-6">
              <div class="small text-muted fw-bold">Modo adquisición</div>
              <div>{{ selectItem.adquisicion || 'N/A' }}</div>
            </div>

            <div class="col-md-3">
              <div class="small text-muted fw-bold">Condición</div>
              <div>{{ selectItem.condicion_fisica || 'N/A' }}</div>
            </div>

            <div class="col-md-3">
              <div class="small text-muted fw-bold">Vida útil</div>
              <div>{{ selectItem.vida_util_meses ?? 'N/A' }}</div>
            </div>

            <div class="col-12">
              <div class="small text-muted fw-bold">Descripción</div>
              <div>{{ selectItem.descripcion || '—' }}</div>
            </div>
          </div>

          <hr class="my-3" />

          <!-- FICHA TECNO si existe -->
          <div *ngIf="selectItem.id_ficha_tecno">
            <div class="fw-bold text-secondary mb-2">Ficha técnica (Tecnología)</div>
            <div class="row g-3">
              <div class="col-md-6"><div class="small text-muted fw-bold">Serial</div>{{ selectItem.serial || '—' }}</div>
              <div class="col-md-6"><div class="small text-muted fw-bold">Procesador</div>{{ selectItem.procesador || '—' }}</div>
              <div class="col-md-4"><div class="small text-muted fw-bold">RAM</div>{{ selectItem.memoria_ram || '—' }}</div>
              <div class="col-md-4"><div class="small text-muted fw-bold">Disco</div>{{ selectItem.disco_duro || '—' }}</div>
              <div class="col-md-4"><div class="small text-muted fw-bold">IP</div>{{ selectItem.direccion_ip || '—' }}</div>
              <div class="col-md-6"><div class="small text-muted fw-bold">SO</div>{{ selectItem.sistema_operativo || '—' }}</div>
              <div class="col-md-6"><div class="small text-muted fw-bold">Host</div>{{ selectItem.host_name || '—' }}</div>
            </div>
          </div>

          <!-- FICHA MUEBLE si existe -->
          <div *ngIf="selectItem.id_ficha_mueble">
            <div class="fw-bold text-secondary mb-2">Ficha técnica (Mobiliario)</div>
            <div class="row g-3">
              <div class="col-md-4"><div class="small text-muted fw-bold">Material</div>{{ selectItem.material || '—' }}</div>
              <div class="col-md-4"><div class="small text-muted fw-bold">Color</div>{{ selectItem.color || '—' }}</div>
              <div class="col-md-4"><div class="small text-muted fw-bold">Dimensiones</div>{{ selectItem.dimensiones || '—' }}</div>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer border-top-0">
        <button type="button" class="btn btn-light text-secondary" (click)="closeDetailModal()">
          Cerrar
        </button>

        <!-- Estos 3 ahora pueden abrir otros modales -->
        <button type="button" class="btn btn-outline-dark" >
          Editar
        </button>
        <button type="button" class="btn btn-outline-dark" >
          Mover
        </button>
        <button type="button" class="btn btn-success text-white" style="background-color: var(--muni-primary);"
          >
          Asignar
        </button>
      </div>

    </div>
  </div>
</div>

<div class="modal-backdrop fade show" *ngIf="showDetailModal"></div>

  <div class="modal-backdrop fade show" *ngIf="showCreateModal"></div>

</div>